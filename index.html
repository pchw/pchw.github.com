
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ぽっちぽちにしてやんよ</title>
  <meta name="author" content="pchw">

  
  <meta name="description" content="GitHub: https://github.com/pchw/node-voicetext npm: https://www.npmjs.org/package/voicetext 前説 HOYAのVoiceText Web APIというのが公開されていたのでNode. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-3153783610869798",
      enable_page_level_ads: true
    });
  </script>
  <link rel="canonical" href="http://pchw.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="ぽっちぽちにしてやんよ" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-13219359-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">ぽっちぽちにしてやんよ</a></h1>
  
    <h2>技術ネタとかアプリに関する話とか</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:pchw.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/10/voicetext/">VoiceText Web APIのNode.jsライブラリ作った</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-10T09:00:00+00:00" pubdate data-updated="true">Jul 10<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>GitHub: <a href="https://github.com/pchw/node-voicetext">https://github.com/pchw/node-voicetext</a></p>

<p>npm: <a href="https://www.npmjs.org/package/voicetext">https://www.npmjs.org/package/voicetext</a></p>

<h1>前説</h1>

<p>HOYAの<a href="https://cloud.voicetext.jp/webapi">VoiceText Web API</a>というのが公開されていたのでNode.jsから叩くライブラリを作った．</p>

<p>VoiceText Web API(β版)は<a href="http://dic.nicovideo.jp/a/%E3%82%B7%E3%83%A7%E3%82%A6%E5%90%9B">ショウ君</a>で有名な<a href="http://voicetext.jp/">VoiceText</a>がスタンドアロンのソフトじゃなくてWebで公開されたやつ．</p>

<p>しかも今のところ無償で利用出来る．</p>

<p>Voice Text Web API自体はHTTPSのPOSTでデータを投げつけたらwavファイルを送り返してくるゴキゲンなやつ．</p>

<h1>はじめにやること</h1>

<p>VoiceText Web APIを使うには，まず利用登録が必要．
<a href="https://cloud.voicetext.jp/webapi/api_keys/new">利用登録画面</a> から<code>名前``メールアドレス</code>などその他入れて登録すればすぐAPIキーが書かれたメールが来る．</p>

<h1>Node.jsからVoiceText Web APIを使う</h1>

<p>おもむろにnpm installする</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install voicetext</span></code></pre></td></tr></table></div></figure>


<p><code>require('voicetext')</code>したらVoiceTextクラスが返ってくるからnewしつつAPIキーをブチ込む</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VoiceText = require('voicetext');
</span><span class='line'>voice = new VoiceText('APIキーをここにコピペする');</span></code></pre></td></tr></table></div></figure>


<p>あとは色々パラメータをいじりつつメソッドチェーンして<code>speak</code>する．
基本的にメソッドは<a href="https://cloud.voicetext.jp/webapi/docs/api">公式ドキュメント</a>のパラメータに合わせるようにした．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>voice
</span><span class='line'>.speaker(voice.SPEAKER.HIKARI)
</span><span class='line'>.emotion(voice.EMOTION.HAPPINESS)
</span><span class='line'>.emotion_level(voice.EMOTION_LEVEL.HIGH)
</span><span class='line'>.pitch(200)
</span><span class='line'>.speed(400)
</span><span class='line'>.volume(200)
</span><span class='line'>.speak('きょうもいちにちがんばるぞい', function(e, buf){
</span><span class='line'>})</span></code></pre></td></tr></table></div></figure>


<p>コールバックの第二引数にwavが詰まったBufferインスタンスが返ってくるので，
<code>fs.writeFile</code>とかしてwavに書き出せばもうすぐに再生できる形だ！</p>

<p>たぶん<a href="https://github.com/TooTallNate/node-wav">node-wav</a>とか使ったらそのまま再生出来るかも．</p>

<p>というわけでNode.js版のVoiceTextライブラリのリポジトリは<a href="https://github.com/pchw/node-voicetext">https://github.com/pchw/node-voicetext</a></p>

<p>chatopsなところはBOTとかに喋らせるといいんじゃないかな．</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/04/synth-routing/">[Synth] ルーティングを増やしてみる</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-04T10:00:00+00:00" pubdate data-updated="true">Jul 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>前説</h1>

<p><a href="/blog/2014/06/28/synth-with-vuejs/">前回</a>でAngularだけではなく自分の好きなクライアントサイドMVCフレームワークが使えるようになったところで，
次はサーバサイドでAPIの追加が必要になってくる頃合いなのでその辺りを触ってみる．</p>

<p><a href="http://synthjs.com">synth</a>は初回にも少し触れたが，<code>back/resources</code>以下がURLにマッピングされている感じになっている．
そのため，<code>back/resources</code>以下にディレクトリを掘って，その中のファイルに<code>exports.XXXXX</code>的なのを書いておけば，
そのままURLのルーティングに反映される．</p>

<p>実際の手順を追ってみる．</p>

<h1>backend側の改修</h1>

<p><code>back/resources</code> にディレクトリ追加する．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ synth install -b bluebird
</span><span class='line'>$ mkdir back/resources/messages
</span><span class='line'>$ cat back/resources/messages/filename_you_want.coffee
</span><span class='line'>Promise = require 'bluebird'
</span><span class='line'>sample = -&gt;
</span><span class='line'>  new Promise (resolve)-&gt;
</span><span class='line'>    setTimeout -&gt;
</span><span class='line'>      resolve 'something'
</span><span class='line'>    , 3000
</span><span class='line'>
</span><span class='line'>exports.getIndex = (req, res)-&gt;
</span><span class='line'>  sample()
</span><span class='line'>  .then (d)-&gt;
</span><span class='line'>    something: d</span></code></pre></td></tr></table></div></figure>


<p>synthは<code>back/resources</code>内の<code>.js</code>または<code>.coffee</code>のファイルの<code>exports</code>を見るため，
ファイル名はなんでもいい，
分かりやすいのを付けるのがいいらしい．</p>

<p>サーバサイドはPromiseを返さないといけないらしいので，<a href="https://github.com/petkaantonov/bluebird">bluebird</a>を使ってPromiseを返してる．</p>

<h1>プリロードテンプレートの改修</h1>

<p><code>front/html</code>内もbackend側に合わせて変える必要がある．
（<code>preloadHTML</code>が必要な場合）</p>

<p><code>front/html</code>内は<code>back/resources</code>内と良く似ているが，ディレクトリに入れるファイル名は規則がある．
<code>exports.getIndex</code>とかだと<code>getIndex.jade</code>または<code>getIndex.html</code>というファイル名にする必要がある．
backend側のAPIと合わせなければいけない．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/html/messages/getIndex.jade
</span><span class='line'>h2 Messages
</span><span class='line'>p </span></code></pre></td></tr></table></div></figure>


<h1>frontend側の改修</h1>

<p>今frontend側にはroutingを入れてなかったので，<code>/messages</code>にアクセスしてもVue側でエラーになる．
<code>v-view</code>と<code>Vue.component</code>を使ってルーティングするロジックを入れる．</p>

<p>まずは<code>index.jade</code>の方に<code>v-view</code>を</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/index.jade
</span><span class='line'>doctype html
</span><span class='line'>html
</span><span class='line'>  head
</span><span class='line'>    meta(charset='utf-8')
</span><span class='line'>    meta(http-equiv='X-UA-Compatible', content='IE=edge,chrome=1')
</span><span class='line'>    meta(name='viewport', content='width=device-width, initial-scale=1.0')
</span><span class='line'>    title= appName
</span><span class='line'>
</span><span class='line'>    for cssFile in cssFiles
</span><span class='line'>      link(rel="stylesheet", href=cssFile)
</span><span class='line'>
</span><span class='line'>    // Preloaded Data
</span><span class='line'>    script.
</span><span class='line'>      window.preloadedData = !{data};
</span><span class='line'>    for jsFile in jsFiles
</span><span class='line'>      script(src=jsFile)
</span><span class='line'>  body
</span><span class='line'>    h1= appName
</span><span class='line'>
</span><span class='line'>    div#content
</span><span class='line'>      div(v-view="currentView")
</span><span class='line'>
</span><span class='line'>    if preloadHTML
</span><span class='line'>      script.template(type="v-template", id="template")
</span><span class='line'>        != preloadHTML</span></code></pre></td></tr></table></div></figure>


<p>次に<code>front-app.coffee</code>の方にURLによって<code>v-view</code>の<code>currentView</code>をcomponentで置換するように書く．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/js/front-app.coffee
</span><span class='line'>$ -&gt;
</span><span class='line'>
</span><span class='line'>  routes = ['tweets', 'messages']
</span><span class='line'>
</span><span class='line'>  getRoute = -&gt;
</span><span class='line'>    path = location.hash.replace(/^#!\?/, '') or 'tweets'
</span><span class='line'>    if routes.indexOf(path) &gt; -1 then path else 'tweets'
</span><span class='line'>    
</span><span class='line'>  Vue.filter "formatDate", (v) -&gt;
</span><span class='line'>    v.replace /T|Z/g, " "
</span><span class='line'>
</span><span class='line'>  Vue.component 'tweets',
</span><span class='line'>    template: '#template'
</span><span class='line'>    created: -&gt;
</span><span class='line'>      @$data.newTweet = "write some tweet."
</span><span class='line'>      if typeof window.preloadedData isnt "undefined"
</span><span class='line'>        @$data = window.preloadedData
</span><span class='line'>        window.preloadedData = null
</span><span class='line'>      else
</span><span class='line'>        $.ajax
</span><span class='line'>          url: "/api/tweets"
</span><span class='line'>          success: (data) =&gt;
</span><span class='line'>            @$data.tweets = data?.tweets
</span><span class='line'>    methods:
</span><span class='line'>      publish: -&gt;
</span><span class='line'>        $.ajax
</span><span class='line'>          type: "POST"
</span><span class='line'>          url: "/api/tweets"
</span><span class='line'>          data:
</span><span class='line'>            content: @$data.newTweet
</span><span class='line'>
</span><span class='line'>          dataType: "json"
</span><span class='line'>          success: (tweet) =&gt;
</span><span class='line'>            @$data.tweets.unshift tweet
</span><span class='line'>            @$data.newTweet = ""
</span><span class='line'>
</span><span class='line'>    Vue.component 'messages',
</span><span class='line'>      template: '#template'
</span><span class='line'>      created: -&gt;
</span><span class='line'>        if typeof window.preloadedData isnt "undefined"
</span><span class='line'>          @$data = window.preloadedData
</span><span class='line'>          window.preloadedData = null
</span><span class='line'>        else
</span><span class='line'>          $.ajax
</span><span class='line'>            url: "/api/messages"
</span><span class='line'>            success: (data) =&gt;
</span><span class='line'>              @$data.something = data?.something
</span><span class='line'>
</span><span class='line'>  app = new Vue
</span><span class='line'>    el: "#content"
</span><span class='line'>    data:
</span><span class='line'>      currentView: do getRoute
</span><span class='line'>      routes: routes</span></code></pre></td></tr></table></div></figure>


<h1>アクセスしてみる</h1>

<p>http://localhost:5000/messages で <code>something</code>的な文字が出るページが表示されて，
http://localhost:5000/tweets で今までのTweets一覧が出るページが表示されるようになる</p>

<h1>まとめ</h1>

<ul>
<li>synthでルーティングを追加してみた</li>
<li>back/resource以下にディレクトリを増やしてファイルを突っ込むだけ</li>
<li>後から見た時にURLとディレクトリ構造が一致しているので分かりやすい</li>
<li>front側もプリロードのテンプレートがfront/html以下に同じディレクトリ構造があるので分かりやすい</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/28/synth-with-vuejs/">[Synth] SynthとVue.jsを組み合わせてみた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-28T16:00:00+00:00" pubdate data-updated="true">Jun 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="/blog/2014/06/27/synth/">前回</a>紹介したAPI-firstなフレームワーク<a href="http://synthjs.com">Synth</a>と<a href="http://vuejs.org">Vue.js</a>を組み合わせて使ってみる．</p>

<p>Synthの<code>$ synth new my_app</code>で生成されるコードは<a href="">Angular.js</a>を使うようになっている．
Angular.js派ではないのでVue.js版に書き換えてみる．
ついでに<a href="http://coffeescript.org">coffee-script</a>派なので，coffee-scriptで動くようにする．</p>

<p>ここまでのコードは<a href="/blog/2014/06/27/synth/">前回</a>参照．Synth公式の<a href="http://www.synthjs.com/tutorial/">チュートリアル</a>を済ませた時点のコードです．</p>

<h1>モジュールの準備</h1>

<h2>Vue.jsインストール</h2>

<p>まず，Vue.jsを使うため，インストールする．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ synth install -f vue
</span><span class='line'>$ synth install -f jquery</span></code></pre></td></tr></table></div></figure>


<h2>Angularのアンインストール</h2>

<p>Angularは使わないので抜く．<code>$ synth uninstall -f angular</code>とやりたいが，未実装っぽい．
あと<code>$ synth install -f</code>時に<code>.bower.json</code>に<code>main</code>キーがないと<code>front/js/jsFiles</code>に記載されないっぽい</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd front
</span><span class='line'>$ bower uninstall angular
</span><span class='line'>$ bower uninstall angular-route</span></code></pre></td></tr></table></div></figure>


<p><code>front/bower.json</code> からも消しておく．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/bower.json
</span><span class='line'>{
</span><span class='line'>  "name": "my_app",
</span><span class='line'>  "private": true,
</span><span class='line'>  "dependencies": {
</span><span class='line'>    "vue": "~0.10.5",
</span><span class='line'>    "jquery": "~2.1.1"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>front/js/jsFiles</code>から不要になったファイルを削除する</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/js/jsFiles 
</span><span class='line'>../bower_components/jquery/dist/jquery.js
</span><span class='line'>../bower_components/vue/dist/vue.js
</span><span class='line'>front-app.js</span></code></pre></td></tr></table></div></figure>


<h1>テンプレートの修正</h1>

<p>DirectivesをAngular用からVue用に書き換える．
dateの<code>medium</code>はVueでは無いので後で<code>formatDate</code>を定義することにする．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/html/tweets/getIndex.jade
</span><span class='line'>textarea(v-text="newTweet")
</span><span class='line'>button(v-on="click: publish()", v-attr="disabled: newTweet.length == 0") Publish
</span><span class='line'>ul.tweet-timeline
</span><span class='line'>  li.tweet(v-repeat="tweet : tweets")
</span><span class='line'>    .content 
</span><span class='line'>    .date </span></code></pre></td></tr></table></div></figure>


<p><code>front/index.jade</code> もVue用に色々修正</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>doctype html
</span><span class='line'>html
</span><span class='line'>  head
</span><span class='line'>    meta(charset='utf-8')
</span><span class='line'>    meta(http-equiv='X-UA-Compatible', content='IE=edge,chrome=1')
</span><span class='line'>    meta(name='viewport', content='width=device-width, initial-scale=1.0')
</span><span class='line'>    title= appName
</span><span class='line'>
</span><span class='line'>    for cssFile in cssFiles
</span><span class='line'>      link(rel="stylesheet", href=cssFile)
</span><span class='line'>
</span><span class='line'>    // Preloaded Data
</span><span class='line'>    script.
</span><span class='line'>      window.preloadedData = !{data};
</span><span class='line'>    for jsFile in jsFiles
</span><span class='line'>      script(src=jsFile)
</span><span class='line'>  body
</span><span class='line'>    h1= appName
</span><span class='line'>
</span><span class='line'>    div#content
</span><span class='line'>
</span><span class='line'>    if preloadHTML
</span><span class='line'>      script.template(type="v-template", id="template")
</span><span class='line'>        != preloadHTML</span></code></pre></td></tr></table></div></figure>


<h2>分からなかった点</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>script(type="text/ng-template", id="#{preloadHTMLPath}")</span></code></pre></td></tr></table></div></figure>


<p>とかなっててngRouteの<code>templateUrl</code>らへんでバインドしてた方法のVue版が分からなかったから普通にid指定にしてしまった．</p>

<h1>Vueのバインディングとcoffee-script化</h1>

<p><code>front/front-app.js</code>を消して<code>front/front-app.coffee</code>にしてVue版にする</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ -&gt;
</span><span class='line'>  Vue.filter "formatDate", (v) -&gt;
</span><span class='line'>    v.replace /T|Z/g, " "
</span><span class='line'>
</span><span class='line'>  content = new Vue
</span><span class='line'>    el: "#content"
</span><span class='line'>    template: "#template"
</span><span class='line'>    data:
</span><span class='line'>      newTweet: "write some tweet."
</span><span class='line'>
</span><span class='line'>    created: -&gt;
</span><span class='line'>      if typeof window.preloadedData isnt "undefined"
</span><span class='line'>        @$data = window.preloadedData
</span><span class='line'>        window.preloadedData = null
</span><span class='line'>      else
</span><span class='line'>        $.ajax
</span><span class='line'>          url: "/api/tweets"
</span><span class='line'>          success: (data) =&gt;
</span><span class='line'>            @$data.tweets = data?.tweets
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    methods:
</span><span class='line'>      publish: -&gt;
</span><span class='line'>        $.ajax
</span><span class='line'>          type: "POST"
</span><span class='line'>          url: "/api/tweets"
</span><span class='line'>          data:
</span><span class='line'>            content: @$data.newTweet
</span><span class='line'>
</span><span class='line'>          dataType: "json"
</span><span class='line'>          success: (tweet) =&gt;
</span><span class='line'>            @$data.tweets.unshift tweet
</span><span class='line'>            @$data.newTweet = ""</span></code></pre></td></tr></table></div></figure>


<p>合わせて<code>front/js/jsFiles</code>も書き換え</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/js/jsFiles 
</span><span class='line'>../bower_components/jquery/dist/jquery.js
</span><span class='line'>../bower_components/vue/dist/vue.js
</span><span class='line'>front-app.coffee</span></code></pre></td></tr></table></div></figure>


<p><img src="https://cloud.githubusercontent.com/assets/1183484/3419737/e84b3ec4-fe76-11e3-8d09-132d59ed6c48.png" alt="image" />
これでめでたくTweetが表示されて，投稿できるようになった．</p>

<h1>まとめ</h1>

<ul>
<li>synthのAngularで動いてたのをVue版に書き直してみた</li>
<li>そんなに変更は難しくなかった．これから新しいクライアントサイドのライブラリが出てきてもサッと変えてテスト出来そう．</li>
<li>よく考えたら当たり前だけどbackend側全然いじってない</li>
<li>API増やしたり，色々するとまたbackend側のディレクトリ構成とかfrontのhtml以下のディレクトリ構成とかハマるポイントが有るけどそれは次の話にする．</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/27/synth/">[Synth] Synthを試してみた</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-27T07:00:00+00:00" pubdate data-updated="true">Jun 27<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://cloud.githubusercontent.com/assets/1183484/3405341/2b8563a0-fd7c-11e3-8782-4eb6dbd4a420.png" alt="synth" /></p>

<h1>tl;dr</h1>

<ul>
<li>SynthっていうAPI-firstなWebフレームワークがある</li>
<li>Turoialを回してみた</li>
<li>RESTfullなAPIとディレクトリ構造，exportsのI/Fを合わせる規約で見通し良い</li>
<li>プリロードの仕組みで初めからレンダリングできるよ！</li>
<li>まだ超beta．</li>
</ul>


<h1>前説</h1>

<p><a href="http://www.synthjs.com/">Synth</a> はNode.js製のAPI-firstなWebフレームワーク．
<code>back/resources</code>ディレクトリに.js/.coffeeを配置して，<code>exports.get = ...</code>とか<code>exports.getIndex =</code>とか<code>exports.&lt;method&gt;&lt;optional: ActionName&gt;</code>な形で書いておくと，<code>myapp/back/resources/memoes</code>が<code>GET /api/memoes</code>とかに答えてくれる．</p>

<p>ひとまず，<a href="http://www.synthjs.com/tutorial/">Tutorial</a> を回して，Angular以外を使う道を探ろう．</p>

<p>あと超betaらしいから地雷踏む勇気が無い人はProductionに使えない．</p>

<h1>インストールとセットアップ</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install -g synth
</span><span class='line'>$ $ synth new my_app
</span><span class='line'>Successfully created a new synth app in my_app</span></code></pre></td></tr></table></div></figure>


<h2>ディレクトリ構造</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd my_app
</span><span class='line'>$ ls
</span><span class='line'>back       front      synth.json
</span><span class='line'>$ ls front/
</span><span class='line'>bower.json css        html       images     index.jade js         misc
</span><span class='line'>$ ls back/
</span><span class='line'>back-app.js       generateTweets.js package.json      resources</span></code></pre></td></tr></table></div></figure>


<p>こんな感じになっている．</p>

<p><strong>front</strong>はクライアントサイドのやつが詰まってる．
<strong>back</strong>はサーバサイドのやつが詰まってる．</p>

<p><code>synth new</code>はTwitterクローンが生成されるみたい．</p>

<h2>パッケージインストール</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ synth install -b
</span><span class='line'>$ synth install -f</span></code></pre></td></tr></table></div></figure>


<p>でそれぞれfrontの<code>bower install</code>とbackの<code>npm install</code>が走る．</p>

<h2>起動</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ synth server -p 5000
</span><span class='line'>synth (in development mode) is now listening on port 5000</span></code></pre></td></tr></table></div></figure>


<p>http://localhost:5000 にアクセスすると表示される．
<code>Synth App</code>とか出て何も表示されない．Tweetを生成してあげないといけないらしい．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ node back/generateTweets.js</span></code></pre></td></tr></table></div></figure>


<p>そしてリロードするとTweetが出た．</p>

<h2>処理の追加</h2>

<p>このままだとただのTweet表示君なので，Tweetする機能を付ける．</p>

<h3>backend側</h3>

<p><code>back/resources/tweets/</code>に<code>.js</code>ファイルを置いて<code>exports.post = ...</code>を書けばいい．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ touch back/resources/tweets/createTweets.js</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat back/resources/tweets/createTweets.js 
</span><span class='line'>  exports.post = function(req, res) {
</span><span class='line'>    if (!req.body.content) {
</span><span class='line'>      throw 422;
</span><span class='line'>    }
</span><span class='line'>    return req.db.collection('tweets').insert({
</span><span class='line'>      content: req.body.content.slice(0, 140),
</span><span class='line'>      created_at: new Date
</span><span class='line'>    });
</span><span class='line'>  };</span></code></pre></td></tr></table></div></figure>


<p>ちなみに<code>back/resources/tweets/createTweets.coffee</code>を置いたら読んでくれなかった．
きっと全部<code>.coffee</code>にしないとダメ．とりあえず先に行く．</p>

<h3>frontend側</h3>

<p><code>/front/js/controllers/tweets.js</code> に処理を追記．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/js/controllers/tweets.js 
</span><span class='line'>angular.module('my_app')
</span><span class='line'>.controller('tweetsController', function ($scope, $http, data) {
</span><span class='line'>  $scope.tweets = data.tweets;
</span><span class='line'>  $scope.publish = function () {
</span><span class='line'>    $http.post('/api/tweets', { content: $scope.newTweet })
</span><span class='line'>    .success(function (tweet) {
</span><span class='line'>      $scope.tweets.unshift(tweet);
</span><span class='line'>    });
</span><span class='line'>    $scope.newTweet = '';
</span><span class='line'>  };</span></code></pre></td></tr></table></div></figure>


<p>こうする．</p>

<p>HTMLの方もボタンを付けたり，textareaを付けたりしないといけない．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat front/html/tweets/getIndex.jade
</span><span class='line'>textarea(ng-model="newTweet")
</span><span class='line'>button(ng-click="publish()", ng-disabled="newTweet.length == 0") Publish
</span><span class='line'>ul.tweet-timeline
</span><span class='line'>  li.tweet(ng-repeat="tweet in tweets")
</span><span class='line'>    .content 
</span><span class='line'>    .date </span></code></pre></td></tr></table></div></figure>


<p>こうする．</p>

<h3>確認</h3>

<p>もう一度 http://localhost:5000 にアクセスすれば，textareaとpublishボタンがある．
hogeとか書いてpublishすればめでたくTweetが追加される．</p>

<h2>Preload</h2>

<p><a href="http://www.synthjs.com/">Synth</a>の強みとしてプリロードの機能があるらしい．
backend側でpromiseで返せば，front側で初めからデータを持った状態でレンダリング出来る．
<a href="https://github.com/rendrjs/rendr">rendr</a> みたいなものか．</p>

<p><code>front/index.jade</code>を確認してみると，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Preloaded Data
</span><span class='line'>script.
</span><span class='line'>  var preloadedData = !{data};</span></code></pre></td></tr></table></div></figure>


<p>とか</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if preloadHTML
</span><span class='line'>  script(type="text/ng-template", id="#{preloadHTMLPath}")
</span><span class='line'>    != preloadHTML</span></code></pre></td></tr></table></div></figure>


<p>ここらへんがプリロードの鍵らしい．</p>

<p><a href="https://github.com/JonAbrams/synth/blob/7085c027881fbc8dcfba2f539508fb82df0a833d/lib/frontendRenderer.js#L26">ソース</a> を覗いてみると，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var renderData = {
</span><span class='line'>  appName: req.appName || 'Synth App',
</span><span class='line'>  jsFiles: assets.jsFiles,
</span><span class='line'>  cssFiles: assets.cssFiles,
</span><span class='line'>  data: prepareData(preload.data),
</span><span class='line'>  preloadHTML: preload.html,
</span><span class='line'>  preloadHTMLPath: htmlPath
</span><span class='line'>};
</span><span class='line'>for (var key in res.renderData) {
</span><span class='line'>  renderData[key] = res.renderData[key];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>がres.renderに渡ってるっぽい．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>exports.get = function(req, res) {
</span><span class='line'>  :
</span><span class='line'>  res.renderData[hoge] = 'fuga'
</span><span class='line'>  :
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>とかbackend側でやってあげれば，front側にデータを渡せそう．</p>

<h2>Angular以外で使ってみる</h2>

<p>時間が来たから，また夜にでも続き書く．</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/11/power-assert/">Coffee-scriptでpower-assertを使ったテストを書く</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-11T00:20:00+00:00" pubdate data-updated="true">Jun 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>tl;dr</h2>

<ol>
<li>@t_wadaさん神</li>
<li>coffee-scriptで<a href="https://github.com/twada/power-assert">power-assert</a>使うときは<a href="https://github.com/twada/espower-coffee">espower-coffee</a>を使おう</li>
</ol>


<h2>あらすじ</h2>

<p>ちょっと前に話題になっていた<a href="https://github.com/twada/power-assert">power-assert</a>を使ってみようとしました．</p>

<p>こんな感じのを用意しました．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>assert = require 'power-assert'
</span><span class='line'>
</span><span class='line'>describe 'array', -&gt;
</span><span class='line'>  beforeEach -&gt;
</span><span class='line'>    @arr = [1,2,3]
</span><span class='line'>  describe '#indexOf()', -&gt;
</span><span class='line'>    it 'should return index when the value is present', -&gt;
</span><span class='line'>      zero = 0
</span><span class='line'>      two = 2
</span><span class='line'>      assert(@arr.indexOf(zero) is two)</span></code></pre></td></tr></table></div></figure>


<p>んで</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mocha --require intelli-espower-loader test/power-assert.coffee</span></code></pre></td></tr></table></div></figure>


<p>みたいに実行したら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  array
</span><span class='line'>    #indexOf()
</span><span class='line'>      1) should return index when the value is present
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  0 passing (4ms)
</span><span class='line'>  1 failing
</span><span class='line'>
</span><span class='line'>  1) array #indexOf() should return index when the value is present:
</span><span class='line'>     AssertionError: false == true</span></code></pre></td></tr></table></div></figure>


<p>あれ，，，ログがショボい，，，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  array
</span><span class='line'>    #indexOf()
</span><span class='line'>      1) should return index when the value is present
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  0 passing (10ms)
</span><span class='line'>  1 failing
</span><span class='line'>
</span><span class='line'>  1) array #indexOf() should return index when the value is present:
</span><span class='line'>     AssertionError: # /Users/pochi/Documents/development/(snip)/test/power-assert.js:16
</span><span class='line'>
</span><span class='line'>assert(this.arr.indexOf(zero) === two)
</span><span class='line'>            |   |       |     |   |   
</span><span class='line'>            |   |       |     |   2   
</span><span class='line'>            |   -1      0     false   
</span><span class='line'>            [1,2,3]                   
</span><span class='line'>
</span><span class='line'>[number] two
</span><span class='line'>=&gt; 2
</span><span class='line'>[number] this.arr.indexOf(zero)
</span><span class='line'>=&gt; -1
</span></code></pre></td></tr></table></div></figure>


<p>こんな感じのを期待したのに！！</p>

<blockquote class="twitter-tweet" lang="en"><p>power-assert使ってみたのに思ったように出力でない．「AssertionError: false == true」って出てしまった</p>&mdash; ぽち＠ (@pchw) <a href="https://twitter.com/pchw/statuses/475911097069744130">June 9, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>とか言ってたら<a href="https://twitter.com/yosuke_furukawa">@yosuke_furukawa</a>が色々助言をくれて，こうなって</p>

<blockquote class="twitter-tweet" data-conversation="none" lang="en"><p><a href="https://twitter.com/pchw">@pchw</a> intelli-espower-loaderへのpull request案件な気がしてきましたね。 <a href="https://t.co/F5tHM0NDqh">https://t.co/F5tHM0NDqh</a></p>&mdash; Yosuke FURUKAWA (@yosuke_furukawa) <a href="https://twitter.com/yosuke_furukawa/statuses/475914266860482560">June 9, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>さらに中をみていくと</p>

<blockquote class="twitter-tweet" lang="en"><p>いや待てよこれ*.coffeeにしてもならないぞ，，，espower-loaderの中の方まで見ていかないと</p>&mdash; ぽち＠ (@pchw) <a href="https://twitter.com/pchw/statuses/475914928562266112">June 9, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>さらに色々調べてたら数カ月前の@mizchiの発言が</p>

<blockquote class="twitter-tweet" lang="en"><p>昨日power-asset 使おうとしてみたけど coffeeと espower が上手く動かんかった</p>&mdash; 俺は平気だよ (@mizchi) <a href="https://twitter.com/mizchi/statuses/468274394368708608">May 19, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>という感じで動作しない感じでした．</p>

<p>TypeScriptでの前例があるように</p>

<blockquote class="twitter-tweet" data-conversation="none" lang="en"><p><a href="https://twitter.com/pchw">@pchw</a> なるほど。。vvakameさんがtypescriptでどうやってやってんだろーと思って中身見たらgrunt-espower使ってたのでそういうことですね。 <a href="https://t.co/mFYljl9QRw">https://t.co/mFYljl9QRw</a></p>&mdash; Yosuke FURUKAWA (@yosuke_furukawa) <a href="https://twitter.com/yosuke_furukawa/statuses/475915916807376896">June 9, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>のようにgruntを使ってjsにコンパイルしてそれを食わせるという方法しか無いように思えた時に @t_wada 降臨．</p>

<blockquote class="twitter-tweet" data-conversation="none" lang="en"><p><a href="https://twitter.com/pchw">@pchw</a> <a href="https://twitter.com/yosuke_furukawa">@yosuke_furukawa</a> 反応遅れてすみません。 CoffeeScript で power-assert 使いたい人意外といらっしゃるみたいですね……Node のローダーではちょっと向かい風ですが、手を考えます <a href="https://t.co/P1WY2nV1fz">https://t.co/P1WY2nV1fz</a></p>&mdash; Takuto Wada (@t_wada) <a href="https://twitter.com/t_wada/statuses/475935334874636288">June 9, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>そしてその翌日</p>

<blockquote class="twitter-tweet" data-conversation="none" lang="en"><p><a href="https://twitter.com/pchw">@pchw</a> <a href="https://twitter.com/yosuke_furukawa">@yosuke_furukawa</a> espower-coffee を作ってみたので試してみてください <a href="https://t.co/U8NM7Eji9k">https://t.co/U8NM7Eji9k</a></p>&mdash; Takuto Wada (@t_wada) <a href="https://twitter.com/t_wada/statuses/476235243221835776">June 10, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p><a href="https://github.com/twada/espower-coffee">espower-coffee</a> が公開されてました！</p>

<h2>使い方</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install espower-coffee --save-dev
</span><span class='line'>$ mocha --require 'espower-coffee/guess' test/**/*.coffee</span></code></pre></td></tr></table></div></figure>


<p><code>grunt-mocha-test</code>を使っているなら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mochaTest:
</span><span class='line'>    options:
</span><span class='line'>      reporter: 'spec'
</span><span class='line'>      require: 'espower-coffee/guess'
</span><span class='line'>      colors: true
</span><span class='line'>      timeout: 10000
</span><span class='line'>    src: [
</span><span class='line'>      'test/power-assert.coffee'
</span><span class='line'>      ] </span></code></pre></td></tr></table></div></figure>


<p>こんな感じ．<code>compilers: 'coffee:coffee-script'</code>は要らないみたいです．</p>

<p>すると</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  array
</span><span class='line'>    #indexOf()
</span><span class='line'>      1) should return index when the value is present
</span><span class='line'> 
</span><span class='line'> 
</span><span class='line'>  0 passing (10ms)
</span><span class='line'>  1 failing
</span><span class='line'> 
</span><span class='line'>  1) array #indexOf() should return index when the value is present:
</span><span class='line'>     AssertionError: # /Users/pochi/Documents/development/(snip)/test/power-assert.coffee:15
</span><span class='line'> 
</span><span class='line'>assert(this.arr.indexOf(zero) === two)
</span><span class='line'>            |   |       |     |   |   
</span><span class='line'>            |   |       |     |   2   
</span><span class='line'>            |   -1      0     false   
</span><span class='line'>            [1,2,3]                   
</span><span class='line'> 
</span><span class='line'>[number] two
</span><span class='line'>=&gt; 2
</span><span class='line'>[number] this.arr.indexOf(zero)
</span><span class='line'>=&gt; -1</span></code></pre></td></tr></table></div></figure>


<p>こんなのが得られて，coffee-scriptでpower-assertが使えました！</p>

<p>ちなみに他のファイルとかは<a href="https://gist.github.com/pchw/3fbed13bd69fb31faca6">こんな感じ</a>でやりました．</p>

<h2>注意点</h2>

<ul>
<li>coffee-scriptは1.7.1以上を要求します</li>
<li>coffee-errorsなどを併用するとショボいログに戻ります</li>
<li>AssertionErrorの行数が実際の.coffeeの行数ではありません．（多段SourceMap対応するまでは仕様とのこと）</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/04/backbone-view/">Backbone.jsでView.renderを書く場合のセオリー</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-04T05:26:00+00:00" pubdate data-updated="true">Dec 4<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>こんにちは、ぽちです．
みなさんBackbone.js使ってますか？Marionetteですか？Chaplinですか？それともngが付いちゃうアレですか？</p>

<p>さて今日は、Backbone.jsのお話です．</p>

<p>タイトルは「Backbone.jsでrenderした時に空divを無くす方法」とかにしようと思ったのですが，なんだかそれに限らない気もしたのでブチあげました．</p>

<h2>時間がない人へのまとめ</h2>

<p>忙しい人のために，一言でまとめるとこうです．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Class HogeView extends Backbone.View
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    @listenTo @model, ‘change’, render
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    $oldel = @$el
</span><span class='line'>    $newel = $(&lt;render HTML by template engine&gt;)
</span><span class='line'>    @setElement $newel
</span><span class='line'>    $oldel.replaceWith $newel</span></code></pre></td></tr></table></div></figure>


<p>次の段落からは簡単な形から流れに沿って最終系になるように説明していきます．</p>

<h2>ベーシックなよくある書き方</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HogeView extends Backbone.View
</span><span class='line'>  el: '.hoge'
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    @$el.html ich.hoge_tmpl()
</span><span class='line'>
</span><span class='line'>&lt;hoge.jade&gt;
</span><span class='line'>.hoge
</span><span class='line'>script#hoge_tmpl(type="text/html")
</span><span class='line'>  p this is hoge</span></code></pre></td></tr></table></div></figure>


<p>よくあるのだと、こういう書き方しますよね．
この場合、elを指定しているので、既に存在する要素にViewを紐付けています．</p>

<p><em>ここで使っているテンプレートエンジンは<a href="http://icanhazjs.com/">ICanHaz.js</a>です．</em></p>

<h2>要素を作成する場合</h2>

<p>次は，既存のの要素ではなく，あるボタンをクリックして
要素を作成するケースを考えてみてください．
クリック時に始めてclassがnewされ，それによってDOMに追加されるケースです．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Class HogeView extends Backbone.View
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    do render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    @$el.html(&lt;HTML rendering by template engine&gt;)
</span><span class='line'>
</span><span class='line'>Class ButtonView extends Backbone.View
</span><span class='line'>  el: '.add-btn'
</span><span class='line'>  events:
</span><span class='line'>    ‘click': 'append'
</span><span class='line'>  append:-&gt;
</span><span class='line'>    v = new HogeView()
</span><span class='line'>    @$el.append(v.el)
</span><span class='line'>
</span><span class='line'>&lt;hoge.jade&gt;
</span><span class='line'>a.add-btn add
</span><span class='line'>script#hoge_tmpl(type="text/html")
</span><span class='line'>  .hoge
</span><span class='line'>    p this is hoge </span></code></pre></td></tr></table></div></figure>


<p>こんな感じですかね．</p>

<p>ここで問題が．
Hogeviewにはelを指定していないので，new時にデフォルトで新しい空divがelになります．
そのあと，renderで.htmlするので空divの中にテンプレートの内容が入ったものがelになります．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div&gt;
</span><span class='line'>  &lt;div class=“hoge”&gt;
</span><span class='line'>    &lt;p&gt;this is hoge&lt;/p&gt;
</span><span class='line'>  &lt;/div&gt;
</span><span class='line'>&lt;/div&gt;</span></code></pre></td></tr></table></div></figure>


<h2>className/tagNameの導入？</h2>

<p>これを回避するには，<code>className</code>や<code>tagName</code>といったpropertyを使うのが一つの方法です．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HogeView extends Backbone.View
</span><span class='line'>  className: '.hoge'
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    @$el.html ich.hoge_tmpl()
</span><span class='line'>
</span><span class='line'>class ButtonView extends Backbone.View
</span><span class='line'>  el: '.add-btn'
</span><span class='line'>  events:
</span><span class='line'>    'click': 'append'
</span><span class='line'>  append:-&gt;
</span><span class='line'>    v = new HogeView()
</span><span class='line'>    @$el.append v.el
</span><span class='line'>
</span><span class='line'>&lt;hoge.jade&gt;
</span><span class='line'>a.add-btn add
</span><span class='line'>script#hoge_tmpl(type="text/html")
</span><span class='line'>    p this is hoge </span></code></pre></td></tr></table></div></figure>


<p>ただし，<code>className</code>を用いるためにテンプレートの一番親の要素(<code>.hoge</code>)をHogeViewに持ってきたため見通しが悪い．</p>

<h2>setElementを使う</h2>

<p>そこで<code>setElement</code>を使います．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HogeView extends Backbone.View
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    @setElement ich.hoge_tmpl()
</span><span class='line'>
</span><span class='line'>class ButtonView extends Backbone.View
</span><span class='line'>  el: '.add-btn'
</span><span class='line'>  events:
</span><span class='line'>    'click': 'append'
</span><span class='line'>  append:-&gt;
</span><span class='line'>    v = new HogeView()
</span><span class='line'>    @$el.append v.el
</span><span class='line'>
</span><span class='line'>&lt;hoge.jade&gt;
</span><span class='line'>a.add-btn add
</span><span class='line'>script#hoge_tmpl(type="text/html")
</span><span class='line'>  .hoge
</span><span class='line'>    p this is hoge </span></code></pre></td></tr></table></div></figure>


<p>とすると空divに挟まずに設定できます．</p>

<h2>Modelの更新をトリガーにViewを更新する場合</h2>

<p>この方法でも，以下のケースのように一度<code>setElement</code>をしたものを更に<code>setElement</code>で置き換えるようなコードでは正しく動作しません．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HogeModel extends Backbone.Model
</span><span class='line'>  defaults:
</span><span class='line'>    index: 0
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    @listenTo Backbone, 'inc', @inc
</span><span class='line'>  inc: -&gt;
</span><span class='line'>    i = @get 'index'
</span><span class='line'>    @set 'index', i+1
</span><span class='line'>class HogeView extends Backbone.View
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    @index = 0
</span><span class='line'>    @listenTo @model, 'change', @render
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    @setElement ich.hoge_tmpl
</span><span class='line'>      index: @index++
</span><span class='line'>
</span><span class='line'>class ButtonView extends Backbone.View
</span><span class='line'>  el: '.add-btn'
</span><span class='line'>  events:
</span><span class='line'>    'click': 'render'
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    v = new HogeView
</span><span class='line'>      model: new HogeModel()
</span><span class='line'>    @$el.append v.el
</span><span class='line'>  render:-&gt;
</span><span class='line'>    Backbone.trigger 'inc'
</span><span class='line'>
</span><span class='line'>&lt;hoge.jade&gt;
</span><span class='line'>script#hoge-tmpl(type=“text/html“)
</span><span class='line'>  .hoge
</span><span class='line'>    p this is hoge</span></code></pre></td></tr></table></div></figure>


<h2>最終系</h2>

<p>これを解決するにはこのようにしてあげれば良いです．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class HogeModel extends Backbone.Model
</span><span class='line'>  defaults:
</span><span class='line'>    index: 0
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    @listenTo Backbone, 'inc', @inc
</span><span class='line'>  inc: -&gt;
</span><span class='line'>    i = @get 'index'
</span><span class='line'>    @set 'index', i+1
</span><span class='line'>class HogeView extends Backbone.View
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    @index = 0
</span><span class='line'>    @listenTo @model, 'change', @render
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    $oldel = @$el
</span><span class='line'>    $newel = ich.hoge_tmpl
</span><span class='line'>      index: @index++
</span><span class='line'>    @setElement $newel
</span><span class='line'>    $oldel.replaceWith $newel
</span><span class='line'>
</span><span class='line'>class ButtonView extends Backbone.View
</span><span class='line'>  el: '.add-btn'
</span><span class='line'>  events:
</span><span class='line'>    'click': 'render'
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    v = new HogeView
</span><span class='line'>      model: new HogeModel()
</span><span class='line'>    @$el.append v.el
</span><span class='line'>  render:-&gt;
</span><span class='line'>    Backbone.trigger 'inc'
</span><span class='line'>
</span><span class='line'>&lt;hoge.jade&gt;
</span><span class='line'>script#hoge-tmpl(type=“text/html“)
</span><span class='line'>  .hoge
</span><span class='line'>    p this is hoge</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Class HogeView extends Backbone.View
</span><span class='line'>  initialize: -&gt;
</span><span class='line'>    @listenTo @model, ‘change’, render
</span><span class='line'>    do @render
</span><span class='line'>  render:-&gt;
</span><span class='line'>    $oldel = @$el
</span><span class='line'>    $newel = $(&lt;render HTML by template engine&gt;)
</span><span class='line'>    @setElement $newel
</span><span class='line'>    $oldel.replaceWith $newel</span></code></pre></td></tr></table></div></figure>


<p>のようにすることで，テンプレートの構造そのままをViewに適用することが出来て，正しく表示も更新されます．</p>

<h2>refs</h2>

<p><a href="http://stackoverflow.com/questions/11594961/backbone-not-this-el-wrapping">http://stackoverflow.com/questions/11594961/backbone-not-this-el-wrapping</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/22/github-two-factor-auth/">Githubの二段階認証を設定しよう</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-22T11:13:00+00:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Githubがログインアタック受けたみたいですね．<a href="https://github.com/blog/1698-weak-passwords-brute-forced">Weak passwords brute forced</a>
そんなときにハラハラしないために2段階認証（two-factor authentication）を入れましょう．</p>

<p>Githubにログインして右上の工具マーク（Account Setting）から設定画面に行きます．
<img src="https://f.cloud.github.com/assets/1183484/1597813/a4207532-531a-11e3-9d50-bf483cdbdf8e.png" alt="2013-11-22 10 56 33" /></p>

<p><code>Account Settings</code> を選んで，<code>Two-factor authentication</code>の<code>Set up two-factor authentication</code>を選択します．
<img src="https://f.cloud.github.com/assets/1183484/1597826/d2c7f22a-531a-11e3-9ede-143c4dc9cc88.png" alt="2013-11-22 10 56 47" /></p>

<p>SMSかアプリか選べと言われるので<code>Set up using app</code>を選びます．
<img src="https://f.cloud.github.com/assets/1183484/1597829/e5300aa6-531a-11e3-8e56-fcf313c4f7ef.png" alt="2013-11-22 10 57 09" /></p>

<p>すると，右側にQRコードが表示された画面になるので，<a href="https://itunes.apple.com/jp/app/google-authenticator/id388497605">Google Authenticator</a> でQRコードを読み込ませます．
すぐに6桁のコードが表示されるので，<code>2. Enter the 6-digit code that the application generates</code>に入力して<code>Enable</code>します．
<img src="https://f.cloud.github.com/assets/1183484/1597842/32d6a058-531b-11e3-99ac-de54e9e0c108.png" alt="2013-11-22 10 57 21" /></p>

<p>これで2段階認証の設定が完了です！</p>

<p>エジプトからのアクセスでファラオに呪いをかけられる心配しなくてよくなりましたね！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/12/mongodb-shell/">MongoDBのShellを使いやすくする方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-12T07:49:00+00:00" pubdate data-updated="true">Nov 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近DBは<a href="http://www.mongodb.org/">MongoDB</a>しか使ってないぽちです，おはようございます！</p>

<p>Node.js + MongoDBの組み合わせで使うことがほとんどなので，スクリプトからは<a href="http://mongoosejs.com/">mongoose</a>を使うのですが，ちょっとDBの中身を確認したりするのでmongodbのshellを使うことも多いです．</p>

<p>普段mongooseを使っていると，mongodbのshellが貧弱で困ることがあります．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; db.users.findOne({_id:"&lt;存在するObjectId&gt;"})
</span><span class='line'>null</span></code></pre></td></tr></table></div></figure>


<p>みたいな．</p>

<p>正しくはこう書かねばなりません．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; db.users.findOne({_id:ObjectId("&lt;存在するObjectId&gt;")})
</span><span class='line'>{
</span><span class='line'>  "_id":ObjectId("&lt;存在するObjectId&gt;")
</span><span class='line'>  :
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>めんどくさい！<code>ObjectId</code>と毎回タイプするのがめんどくさい！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; db.users.findOneById("&lt;存在するObjectId&gt;")</span></code></pre></td></tr></table></div></figure>


<p>と書ければ楽だなーと思って探したら，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; DBCollection.prototype.findOneById = function(id){return this.findOne({_id:ObjectId(id)});};</span></code></pre></td></tr></table></div></figure>


<p>とかやってあげると</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>db.users.findOneById("&lt;存在するObjectId&gt;")
</span><span class='line'>{
</span><span class='line'>  "_id":ObjectId("&lt;存在するObjectId&gt;")
</span><span class='line'>  :
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>楽ちんだ！</p>

<p><code>findOneById</code>とか長い！</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; DBCollection.prototype.findOneById = DBCollection.prototype.fbi = function(id){return this.findOne({_id:ObjectId(id)});};
</span><span class='line'>db.users.fbi("&lt;存在するObjectId&gt;")
</span><span class='line'>{
</span><span class='line'>  "_id":ObjectId("&lt;存在するObjectId&gt;")
</span><span class='line'>  :
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>楽ちんだ！！！！さすがFBI！！！連邦捜査局！！！</p>

<p>はい，でもこれを毎回打つのが超めんどくさい．</p>

<p>そういう時は，<code>~/.mongorc.js</code>を配置しましょう．</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "DBCollection.prototype.findOneById = DBCollection.prototype.fbi = function(id){return this.findOne({_id:ObjectId(id)});};" &gt; ~/.mongorc.js
</span><span class='line'>$ mongo hoge
</span><span class='line'>&gt; db.users.fbi("&lt;存在するObjectId&gt;")
</span><span class='line'>{
</span><span class='line'>  "_id":ObjectId("&lt;存在するObjectId&gt;")
</span><span class='line'>  :
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>楽ちん！</p>

<p>上では<code>findOneById</code>だけですが，どんどん追加できるので，決まったaggregateがあるならパラメータを渡す簡単構文でaggregateしたりmongooseでいう<code>populate</code>的な動作も出来ると思います．</p>

<p><a href="https://github.com/skratchdot/mesh">mesh</a>というmongo shellに色々ライブラリを読み込んでくれるのもあるのですが，欲しいのがなかったので自分で作って公開するといいよ！</p>

<h2>まとめ</h2>

<ul>
<li><code>~/.mongorc.js</code>にmongo shellを拡張するスクリプトを置くと便利！</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/11/backbone-event-logger/">Backbone.jsのイベントをデバッグ出力するやつをモジュール化した</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-11T09:10:00+00:00" pubdate data-updated="true">Nov 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>土日で艦これイベント海域E-4をなんとか突破したぽちです，おはようございます．</p>

<p>今日は島風轟沈の日らしいですね．</p>

<p>ktty1220 さんの<a href="http://qiita.com/ktty1220/items/f1bb5b4eb48839de8394">Backbone.jsで全イベントをconsoleに出力するデバッグ用スクリプト</a></p>

<p>が便利だったので使ってたのですが，
毎回<code>backbone.debug.js</code>をプロジェクトにコピーして回るのが大変だったので
bowerでサクッとインストール出来るようにしてみました．</p>

<p><a href="https://github.com/pchw/backbone-event-logger">backbone-event-logger</a></p>

<h3>使い方</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bower install backbone-event-logger</span></code></pre></td></tr></table></div></figure>


<p>でインストールされます．</p>

<p>あとは</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;script src="/bower_components/backbone/backbone-min.js"&gt;&lt;/script&gt;
</span><span class='line'>&lt;script src="/bower_components/backbone-event-logger/backbone-event-logger.min.js"&gt;&lt;/script&gt;</span></code></pre></td></tr></table></div></figure>


<p>みたいに読みこめば，ガンガンログが出ます．</p>

<h3>オリジナルとの違い</h3>

<p>オリジナルと変更した部分としては</p>

<ul>
<li><code>Backbone[&lt;ModelとかRouterとか&gt;]::initialize</code>で自動的にログ出力を有効化</li>
<li>デフォルトで<code>@constructor.name</code>をログに出すようにした</li>
<li>coffee化</li>
<li>名前を<code>.debug</code>から<code>.event-logger</code>へ（デバッグっていうよりロガーだなと思ったので）</li>
<li>AMD/RequireJSでも読み込めるようにしてみた（けど試してない）</li>
</ul>


<h3>こんな感じで出ます</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>23:04:42 Model:ContentModel  remove [&gt; [ContentModel, Contents, Object]</span></code></pre></td></tr></table></div></figure>


<p><code>ContentModel</code> って書いてる部分が<code>@constructor.name</code>で出してるところ．</p>

<h3>イマイチなところ</h3>

<p>オリジナルにあったスタイルの変更等は<code>bower install</code>した後に
<code>bower_components</code>内を変更しないといけなくて，悩んでいるところ．
（自動適用にしたので外部から設定する口を用意してもイマイチかなと）</p>

<p>ところで<code>bower install</code>した時って<code>backbone-event-logger.min.js</code>や<code>backbone-event-logger.js</code>
以外のファイルは配置されるべきなんだろうか？ルールがわからない．
（backbone.jsのbowerも配置されてた）</p>

<h3>まとめ</h3>

<ul>
<li>便利な<a href="http://qiita.com/ktty1220/items/f1bb5b4eb48839de8394">Backbone.jsで全イベントをconsoleに出力するデバッグ用スクリプト</a> をモジュール化した</li>
<li>自動読み込みや名前の表示などオリジナル版をちょっとカスタムしてる</li>
<li>PR/forkどうぞ <a href="https://github.com/pchw/backbone-event-logger">backbone-event-logger</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/21/pararaxwallpaper/">iOS7のパララックス効果で左右に動く壁紙を自作する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-21T01:20:00+00:00" pubdate data-updated="true">Sep 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>iPhone 5s/5cを買うのを諦めたぽちです，こんばんは！</p>

<p>そんなわけでとっととiPhone4SにiOS7をいれて使ってます．</p>

<p>今まで使ってた壁紙が使えなくなって悲しみの極みですが，
嘆いていても仕方がないので，新しく作るしかないです．</p>

<p>iOS7からは左右に振ると壁紙が左右にキモい動きをする機能が入ってるっぽいです．
検索したらキモい動きを切る方法ばっかり出てきたので，作り方を書いておくです．</p>

<p>実は超カンタンで，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iPad 2 and iPad mini: 1,424 x 1,424
</span><span class='line'>iPad 3 and iPad 4: 2,448 x 2,448
</span><span class='line'>iPhone 4S: 1,360 x 1,040
</span><span class='line'>iPhone 5: 1,536 x 1,040</span></code></pre></td></tr></table></div></figure>


<p>のサイズで作ればいいだけでした．</p>

<p>この機能の呼び名がパララックス効果壁紙（parallax effect wallpapers）とか
ダイナミック壁紙（dynamic wallpapers）とか色々言われてるっぽいですけど，どれが一般的な呼び名なんでしょうね．</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p><img src="/images/pMac.png"/></p>
  <p>ぽち</p>
  <p>iPhoneアプリとかWebサービスとか作ってます．</p>
</section>

<section>
  <h1>Twitter</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("pchw", 0, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/pchw" class="twitter-follow-button" data-show-count="false">Follow @pchw</a>
  
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/10/voicetext/">VoiceText Web APIのNode.jsライブラリ作った</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/04/synth-routing/">[Synth] ルーティングを増やしてみる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/28/synth-with-vuejs/">[Synth] SynthとVue.jsを組み合わせてみた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/27/synth/">[Synth] Synthを試してみた</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/11/power-assert/">coffee-scriptでpower-assertを使ったテストを書く</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/app'>App (1)</a></li><li><a href='/blog/categories/appstore'>AppStore (1)</a></li><li><a href='/blog/categories/backbone-js'>backbone.js (1)</a></li><li><a href='/blog/categories/backbone-js'>Backbone.js (1)</a></li><li><a href='/blog/categories/github'>github (1)</a></li><li><a href='/blog/categories/github'>GitHub (1)</a></li><li><a href='/blog/categories/hub'>hub (1)</a></li><li><a href='/blog/categories/ios7'>iOS7 (1)</a></li><li><a href='/blog/categories/iphone'>iPhone (1)</a></li><li><a href='/blog/categories/jquery'>jquery (1)</a></li><li><a href='/blog/categories/mongodb'>mongodb (1)</a></li><li><a href='/blog/categories/octopress'>octopress (1)</a></li><li><a href='/blog/categories/power-assert'>power-assert (1)</a></li><li><a href='/blog/categories/rubymotion'>RubyMotion (27)</a></li><li><a href='/blog/categories/sublimetext2'>SublimeText2 (2)</a></li><li><a href='/blog/categories/synth'>synth (3)</a></li><li><a href='/blog/categories/voicetext'>voicetext (1)</a></li><li><a href='/blog/categories/vue-js'>Vue.js (2)</a></li></ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - pchw -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'pchw';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
